---
# tasks file for docker-transmission
- include: "{{ansible_os_family}}.yml"

- name: Install python bindings for docker
  pip:
    name: docker-py


- name: Create Docker paths
  file:
    path: "{{ docker_libreNMS_storage }}/{{ item }}"
    state: directory
    mode: 0775
  with_items:
    - logs
    - rrd
    - config
    - db/data
    - db/config

- name: Install Configuration File
  template:
    src: config.custom.php.j2
    dest: "{{ docker_libreNMS_storage }}/config/config.custom.php"
    mode: 0644


# - name: Create and Update LibreNMS Database
#   docker_container:
#     name: libreNMS_DB
#     image: mariadb:10.3
#     state: started
#     restart_policy: unless-stopped
#     recreate: no
#     restart: no
#     pull: true
#     volumes:
#         - "{{ docker_libreNMS_storage }}/db/data:/var/lib/mysql"
#         - "{{ docker_libreNMS_storage }}/db/config:/etc/mysql/conf.d"
#     env:
#       MYSQL_ROOT_PASSWORD: password
#       MYSQL_DATABASE: librenms
#       MYSQL_USER: librenms
#       MYSQL_PASSWORD: librenms

- name: Create and Update LibreNMS Container
  docker_container:
    name: libreNMS
    image: jarischaefer/docker-librenms
    state: started
    restart_policy: unless-stopped
    recreate: no
    restart: yes
    pull: true
    exposed_ports:
        - 80
    published_ports:
        - 8668:80
    volumes:
        - "{{ docker_libreNMS_storage }}/logs:/opt/librenms/logs"
        - "{{ docker_libreNMS_storage }}/rrd:/opt/librenms/rrd"
        - "{{ docker_libreNMS_storage }}/config/config.custom.php:/opt/librenms/config.custom.php:ro"
    env:
      DB_HOST: "{{ docker_libreNMS_sql_ip }}"
      DB_PORT: "{{ docker_libreNMS_sql_port }}"
      DB_USER: "{{ docker_libreNMS_sql_username }}"
      DB_PASS: "{{ docker_libreNMS_sql_password }}"
      DB_NAME: "{{ docker_libreNMS_sql_database_name }}"
      PUID: "{{ docker_libreNMS_PUID }}"
      PGID: "{{ docker_libreNMS_PGID }}"
      TZ: "America/Chicago"
      BASE_URL: "{{ docker_libreNMS_base_url }}"
      POLLERS: 16


- name: Open Ports for transmission firewallD
  firewalld:
    port: "{{ item }}"
    permanent: true
    state: enabled
  with_items:
    - "{{ docker_ports }}"
  notify: Restart firewalld
  when: ansible_distribution == "CentOS"

- name: Open Ports for transmission UFW
  ufw:
    port: "{{ item }}"
    rule: allow
  with_items:
    - "{{ docker_portsUFW }}"
  notify: Restart UFW
  when: ansible_distribution == "Ubuntu"

- name: Install Python influxDB Client
  pip:
    state: present
    name: influxdb
  when: "docker_libreNMS_influxdb  == true"

- name: Create influxDB Database for LibreNMS
  influxdb_database:
      hostname: "{{ docker_libreNMS_influxdb_ip }}"
      database_name: "{{ docker_libreNMS_influxdb_database_name }}"
      port: "{{ docker_libreNMS_influxdb_port }}"
      username: "{{ docker_libreNMS_influxdb_username }}"
      password: "{{ docker_libreNMS_influxdb_password }}"
      state: present
  when: "docker_libreNMS_influxdb  == true"